version: "3.8"

# YouTube Live Streaming Scheduler - Docker Compose
# Services:
#  - Traefik v2.10 reverse proxy with HTTPS redirect and dashboard
#  - MongoDB v6 (no auth, dev only) with persistent volume
#  - Backend (Node 18) built from ./backend, exposes /api
#  - Frontend (Nginx Alpine) serving ./frontend static files
# Networks:
#  - web (external) â€” create it once with: docker network create web
# Volumes:
#  - mongodb_data for MongoDB persistence

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    # Minimal runtime config via CLI; you can also use files in ./traefik
    command:
      - --api.insecure=true                 # enable dashboard on :8080 (dev only)
      - --providers.docker=true             # watch docker labels
      - --providers.file.filename=/etc/traefik/dynamic-config.yml
      - --entrypoints.http.address=:80
      - --entrypoints.https.address=:443
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"                       # dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic-config.yml:/etc/traefik/dynamic-config.yml:ro
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      # Global HTTP -> HTTPS redirect (catch-all HTTP router)
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=http"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  mongo:
    image: mongo:6
    container_name: mongo
    restart: unless-stopped
    # Expose for local dev tools; remove if not needed
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - web
    # No auth for development (do not use in production)
    environment:
      - MONGO_INITDB_ROOT_USERNAME=
      - MONGO_INITDB_ROOT_PASSWORD=
    healthcheck:
      test: ["CMD-SHELL", "echo 'db.runCommand({ ping: 1 })' | mongosh --quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  backend:
    build:
      context: ./backend
    image: youtube-scheduler-backend:dev
    container_name: backend
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3000
      - MONGODB_URI=mongodb://mongo:27017/youtube-scheduler
    volumes:
      - ./backend:/usr/src/app
      - ./videos:/usr/src/app/videos
    networks:
      - web
    depends_on:
      mongo:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.backend.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=https"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.services.backend.loadbalancer.server.port=3000"
    # Expects the backend to expose /health returning 200 OK
    healthcheck:
      test: ["CMD-SHELL", "node -e \"http=require('http'); req=http.request({host:'localhost',port:3000,path:'/health'}, res=>process.exit(res.statusCode===200?0:1)); req.on('error', ()=>process.exit(1)); req.end();\""]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s

  frontend:
    image: nginx:alpine
    container_name: frontend
    restart: unless-stopped
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend.entrypoints=https"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

networks:
  web:
    external: true   # Create with: docker network create web

volumes:
  mongodb_data: